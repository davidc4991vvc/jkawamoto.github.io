<!DOCTYPE html> <html> <head prefix="og: http://ogp.me/ns#"> <meta charset="utf-8"> <meta http-equiv="content-language" content="ja"> <title>Go &middot; Junpei Kawamoto</title> <base href="https://www.jkawamoto.info/"> <meta name="generator" content="Hugo 0.16"> <meta name="viewport" content="width=device-width,initial-scale=1"> <meta name="author" content="Junpei Kawamoto"> <meta name="description" content="Homepage of Junpei Kawamoto."> <meta property="og:type" content="article"> <meta property="og:title" content="Go &middot; Junpei Kawamoto"> <meta name="og:description" content="Homepage of Junpei Kawamoto."> <meta property="og:image" content="https://www.jkawamoto.info/images/wordcloud.png"> <meta property="og:site_name" content="Junpei Kawamoto"> <meta name="twitter:card" content="Homepage of Junpei Kawamoto."> <meta name="twitter:site" content="@junkawamoto"> <link rel="stylesheet" href="/css/main.css"> <link rel="preload" as="style" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" onload='this.rel="stylesheet"'> <link rel="preload" as="style" href="/css/custom.css" onload='this.rel="stylesheet"'> <noscript> <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"> <link rel="stylesheet" href="/css/custom.css"> </noscript> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-4734862314145555",enable_page_level_ads:!0})</script> </head> <body id="top"> <div class="remodal-bg"> <header id="header"> <a href="#" class="image avatar"><img src="/images/avatar.jpg" alt=""></a> <h1 style="text-shadow:1px 1px 5px #000;color:rgba(255,255,255,.7)"><strong>Junpei Kawamoto</strong>, Ph.D. in Informatics.<br>Research scientist working with data mining, security, and privacy.</h1> <br> <ul style="list-style:none;text-shadow:1px 1px 5px #000;margin:0"> <li style="display:inline-block"><a href="/#main">Home</a></li> <li style="display:inline-block"><a href="/blogs/#main">Blog</a></li> <li style="display:inline-block"><a href="/publications/#main">Publications</a></li> <li style="display:inline-block"><a href="/research/#main">Research</a></li> <li style="display:inline-block"><a href="/lectures/#main">Lectures</a></li> </ul> <ul style="list-style:none;text-shadow:1px 1px 5px #000"> <li style="display:inline-block"><a href="/japanese/#main">日本語</a></li> <li style="display:inline-block"><a href="/publications-ja/#main">論文リスト</a></li> <li style="display:inline-block"><a href="/blog-ja/#main">メモ</a></li> <li style="display:inline-block"><a href="/activity-ja/#main">その他の活動</a></li> </ul> </header> <div id="main"> <h1></h1> <section> <h2 id="summary">Summary</h2> <p>You usually employ remote CI services such as <a href="https://travis-ci.org">Travis CI</a> to automatically test your projects hosted in <a href="https://github.com/">GitHub</a>. Your tests should be passed in such CI services always because you have made sure your codebase passes the tests before pushing. However, <code>.travis.yml</code>, the configuration file of Travis, sometimes has bugs and your dependency list sometime loses any libraries.</p> <p>If your codebase fails tests in remote CI services, you need to fix bugs and re-push, and your commit history gets messy. If you&rsquo;re working with colleague&rsquo;s repository, you should care about it more.</p> <p>To evaluate those tests locally, I made <a href="https://jkawamoto.github.io/loci/">Loci</a>, which runs tests in a sandbox based on <a href="https://www.docker.com/">Docker</a>. Loci currently supports <a href="https://www.python.org/">Python</a> and <a href="https://golang.org/">Go</a> projects.</p> <h2 id="installation">Installation</h2> <p>Loci uses <a href="https://www.docker.com/">Docker</a>. If you don&rsquo;t have it, install it first.</p> <p>You can install Loci in several ways. If you&rsquo;re familiar with <a href="https://golang.org/">Go</a>, run</p> <pre><code>$ go get github.com/jkawamoto/loci
</code></pre> <p>or if you&rsquo;re a <a href="http://brew.sh/">Homebrew</a> user, run</p> <pre><code>$ brew tap jkawamoto/loci
$ brew install loci
</code></pre> <p>Otherwise, you can get a compiled binary from <a href="https://github.com/jkawamoto/loci/releases">GitHub</a>.</p> <h2 id="usage">Usage</h2> <p>If your current directory has <code>.travis.yml</code>, just run <code>loci</code> command. If you want to test another file, give the path after <code>loci</code> command like <code>loci &lt;path&gt;</code>. First time, Loci build container images which install dependent packages listed in <code>.travis.yml</code>, and it may take long time, but those images can be reusable.</p> <p>If you have cache servers of APT repository and PyPI repository, give their addresses via <code>--apt-proxy</code> and <code>--pypi-proxy</code> flags. Those cache servers may reduce network traffic and building time.</p> <p>Here is the whole command line options of Loci:</p> <pre><code>loci [global options] [script file]

  If script file isn't given, .travis.yml will be used.

GLOBAL OPTIONS:
   --name NAME, -n NAME  creating a container named NAME to run tests,
                         and that container will not be deleted.
   --tag TAG, -t TAG     creating an image named TAG.
   --base TAG, -b TAG    use image TAG as the base image.
                         (default: &quot;ubuntu:latest&quot;)
   --verbose             verbose mode, which prints Dockerfile and
                         entrypoint.sh.
   --apt-proxy URL       URL for a proxy server of apt repository.
                         [$APT_PROXY]
   --pypi-proxy URL      URL for a proxy server of pypi repository.
                         [$PYPI_PROXY]
   --http-proxy URL      URL for a http proxy server. [$HTTP_PROXY]
   --https-proxy URL     URL for a https proxy server. [$HTTPS_PROXY]
   --no-proxy LIST       Comma separated URL LIST for which proxies won't
                         be used. [$NO_PROXY]
   --help, -h            show help
   --version, -v         print the version
</code></pre> <h2 id="future-work">Future work</h2> <p>Loci currently supports Python and Go projects. I&rsquo;ll supports other languages and welcome any pull requests.</p> </section> <section> <h2 id="summary">Summary</h2> <p>In order to obtain log data from <a href="https://cloud.google.com/">Google Cloud Platform</a>, using the <a href="https://cloud.google.com/stackdriver/">Stackdriver</a> client which <a href="https://godoc.org/cloud.google.com/go/logging/logadmin">logadmin</a> package provides is one of the easiest ways. But, the type of log entries returned by the client is <a href="https://godoc.org/cloud.google.com/go/logging#Entry">logging.Entry</a>, and the type of payloads is <code>interface{}</code>, which means you need to cast payloads to access their fields. This article introduces how to cast them with a pre-defined structure.</p> <h2 id="logadmin-package">logadmin package</h2> <p><a href="https://godoc.org/cloud.google.com/go/logging/logadmin">logadmin</a> provides interfaces to access logs in <a href="https://cloud.google.com/">Google Cloud Platform</a>.</p> <p>The following code obtains log entries matching a query in variable <code>filter</code>:</p> <pre><code>import (
    &quot;cloud.google.com/go/logging/logadmin&quot;
    &quot;golang.org/x/net/context&quot;
    &quot;google.golang.org/api/iterator&quot;
)

func GetLogEntries(filter string) error{
    ctx := context.Background()
    client, err := logadmin.NewClient(ctx, &quot;your-project-id&quot;)
    if err != nil {
        return err
    }
    defer client.Close()

    iter := client.Entries(ctx, logadmin.Filter(filter))
    for {
        e, err := iter.Next()
        if err == iterator.Done {
            return nil
        } else if err != nil {
            return err
        }
        // Use log entry `e`, of which type is logging.Entry.
    }
}
</code></pre> <h2 id="logging-entry">logging.Entry</h2> <p>The type of log entries which the logadmin client returns is <a href="https://godoc.org/cloud.google.com/go/logging#Entry">logging.Entry</a>, and the type of their payload is <code>interface{}</code>. To access each field of those payloads, you need to case them. In most cases, you can cast those payloads to pointers of <a href="https://godoc.org/github.com/golang/protobuf/ptypes/struct#Struct"><code>structpb.Struct</code></a>. Since <code>structpb.Struct</code> is a kind of meta-structure, you also need to convert an instance of <code>structpb.Struct</code> to another structure.</p> <p>My <a href="https://github.com/jkawamoto/structpbconv"><code>structpbconv</code></a> package provides such conversion.</p> <h2 id="structpbconv">structpbconv</h2> <p>The following code converts a log payload of a VM instance&rsquo;s activity_log in <a href="https://cloud.google.com/compute/">Compute Engine</a> from a <code>structpb.Struct</code> instance.</p> <pre><code>import (
    &quot;github.com/golang/protobuf/ptypes/struct&quot;
    &quot;github.com/jkawamoto/structpbconv&quot;
)


type ActivityPayload struct {
    EventTimestampUs string `structpb:&quot;event_timestamp_us&quot;`
    EventType        string `structpb:&quot;event_type&quot;`
    TraceID          string `structpb:&quot;trace_id&quot;`
    Actor            struct {
        User string
    }
    Resource struct {
        Zone string
        Type string
        ID   string
        Name string
    }
    Version      string
    EventSubtype string `structpb:&quot;event_subtype&quot;`
    Operation    struct {
        Zone string
        Type string
        ID   string
        Name string
    }
}

func NewActivityPayload(payload *structpb.Struct) *ActivityPayload {
    var res ActivityPayload
    structpbconv.Convert(payload, &amp;res)
    return &amp;res
}
</code></pre> <p>I defined <code>ActivityPayload</code> structure according to an actual payload of activity_log. To give a mapping of field names, use a <code>structpb</code> tag.</p> <p>Finally, we can access each field like that:</p> <pre><code>// Getting log entries of which event types are GCE_OPERATION_DONE.
iter := client.Entries(
  ctx, logadmin.Filter(&quot;jsonPayload.event_type = \&quot;GCE_OPERATION_DONE\&quot;&quot;))
for {
    e, err := iter.Next()
    if err == iterator.Done {
        return nil
    } else if err != nil {
        return err
    }

    // Converting the payload.
    if s, ok := e.Payload.(*structpb.Struct); ok {
        payload := NewActivityPayload(s)

        // Printing trace_id.
        fmt.Println(payload.TraceID)
    }

}
</code></pre> </section> </div> <footer id="footer"> <ul class="icons"> <li><a href="//facebook.com/junpei.kawamoto" target="_blank" class="icon fa-facebook"><span class="label">Facebook</span></a></li> <li><a href="//twitter.com/junkawamoto" target="_blank" class="icon fa-twitter"><span class="label">Twitter</span></a></li> <li><a href="//github.com/jkawamoto" target="_blank" class="icon fa-github"><span class="label">Github</span></a></li> <li><a href="///www.linkedin.com/in/jkawamoto" target="_blank" class="icon fa-linkedin"><span class="label">LinkedIn</span></a></li> <li><a href="//www.youtube.com/channel/UCAImvZQSpr4dw6USxHNqDXg" target="_blank" class="icon fa-youtube"><span class="label">Youtube</span></a></li> <li><a href="//flickr.com/photos/junkawamoto" target="_blank" class="icon fa-flickr"><span class="label">Flickr</span></a></li> <li><a href="mailto:junpei.kawamoto@acm.org" class="icon fa-envelope-o"><span class="label">Email</span></a></li> <li><a href="#" data-remodal-target="wallet" class="icon fa-btc"><span class="label">BTC</span></a></li> </ul> <ul class="copyright"> <li>&copy; Junpei Kawamoto</li> <li>Design: <a href="//html5up.net">HTML5 UP</a></li> <li><a href="https://www.littlekitune.org/">Little Kitune studio</a></li> </ul> </footer> <aside> <script src="/js/jquery.min.js"></script> <script src="/js/jquery.poptrox.min.js"></script> <script src="/js/skel.min.js"></script> <script src="/js/util.js"></script> <script src="/js/main.js"></script> <script>var _gaq=[["_setAccount","UA-19410992-1"],["_trackPageview"]];!function(e,t){var a=e.createElement(t),o=e.getElementsByTagName(t)[0];a.src=("https:"==location.protocol?"//ssl":"//www")+".google-analytics.com/ga.js",o.parentNode.insertBefore(a,o)}(document,"script")</script> <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/styles/agate.min.css"> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script> <script>hljs.initHighlightingOnLoad()</script> <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-57f285f012d45509"></script> </aside> </div> <div class="remodal" data-remodal-id="wallet"> <button data-remodal-action="close" class="remodal-close"></button> <h1>Bitcoin wallet</h1> <p> My wallet address: <span>1625kBbXoGRWRh92XcgLFik5E6PgV482sm</span> <br> <img src="https://chart.googleapis.com/chart?chs=250x250&cht=qr&chl=bitcoin:1625kBbXoGRWRh92XcgLFik5E6PgV482sm"> </p> <br> <button data-remodal-action="cancel" class="remodal-cancel">Close</button> </div> <link rel="stylesheet" href="css/remodal.css"> <link rel="stylesheet" href="css/remodal-default-theme.css"> <script src="js/remodal.min.js"></script> </body> </html> 